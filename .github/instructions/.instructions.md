# Flashlight Repository Instructions for Coding Agents

## Repository Overview

Flashlight is a Go-based proxy service to the Hypixel API, designed as the backend for the Prism overlay - an open source stats overlay for Hypixel Bedwars. The application is deployed as a Google Cloud Run service (despite some documentation references to "Cloud functions") and follows hexagonal/clean architecture principles.

**Key Facts:**
- Language: Go 1.22+ (currently uses Go 1.23.3)
- Architecture: Hexagonal/Clean Architecture with domain-driven design
- Database: PostgreSQL with migrations
- Deployment: Google Cloud Run 
- Size: ~50 Go source files, moderate complexity
- Dependencies: Sentry, TTL cache, database migrations, rate limiting

## Build and Development Commands

**CRITICAL: Always run these commands in sequence for any code changes:**

1. **Format code**: `go fmt ./...` (REQUIRED before any commit)
2. **Vet code**: `go vet ./...` (REQUIRED before any commit)  
3. **Tidy modules**: `go mod tidy` (run if dependencies change)
4. **Build**: `go build` (builds main binary)
5. **Test**: `go test ./internal/...` (requires PostgreSQL for full tests)

**Build utilities** (also checked in CI):
```bash
go build ./cmd/get-stats/main.go
go build ./cmd/fix-fixtures/main.go
```

**Pre-commit hooks are configured** - the following checks will run automatically:
- go-fmt, go-vet, go-unit-tests, go-build, go-mod-tidy
- YAML validation, merge conflict detection

### Local Development Setup

**Required Environment Setup:**
1. Create environment file: `echo 'export HYPIXEL_API_KEY=<your-key>' > cmd/.env`
2. Start server: `./cmd/run.sh [port]` (defaults to port 8123)
3. Test endpoint: `curl 'localhost:8123/v1/playerdata?uuid=<uuid>'`

**Environment Variables (for production/staging):**
- `HYPIXEL_API_KEY` - Required for all environments
- `FLASHLIGHT_ENVIRONMENT` - `development`/`staging`/`production` 
- `DB_PASSWORD`, `DB_USERNAME` - Database credentials
- `SENTRY_DSN` - Error reporting (optional in development)
- `CLOUDSQL_UNIX_SOCKET` - Cloud SQL connection path

### Testing

**Test Requirements:**
- PostgreSQL database required for repository tests
- GitHub Actions CI runs with PostgreSQL service container
- Database name: `flashlight` (created automatically in CI)

**Test Commands:**
```bash
# Run all tests (requires PostgreSQL)
go test -v ./internal/...

# Test with coverage
go test -cover ./internal/...
```

**Rate Limiting Tests:**
- `./cmd/test-user-id-rate-limit.sh` - Tests user ID based rate limiting
- `./cmd/test-ip-rate-limit.sh` - Tests IP based rate limiting
- Both scripts start a local server, issue requests, and verify rate limiting behavior

### Build Validation

**The GitHub Actions workflow validates:**
1. `go mod tidy` (no changes to go.mod/go.sum)
2. `go fmt ./...` (no formatting changes)  
3. `go vet ./...` (no vet warnings)
4. `go mod verify` (dependency integrity)
5. PostgreSQL database creation and connectivity
6. `go test -v ./internal/...` (all tests pass)
7. Build binaries: main + utility commands
8. Rate limiting integration tests

**Deployment validation** (for production):
- Deploys test instance to Google Cloud Run
- Makes HTTP request to verify deployment works
- Searches response for expected content (username 'Skydeath')

## Project Architecture and Layout

### Directory Structure

```
/
├── main.go                    # Application entry point, server setup
├── go.mod, go.sum            # Go module files
├── cmd/                      # Utility scripts and commands
│   ├── run.sh               # Local development server script  
│   ├── deploy.sh            # Google Cloud Run deployment
│   ├── test-*-rate-limit.sh # Rate limiting integration tests
│   ├── get-stats/           # Statistics utility command
│   └── fix-fixtures/        # Test fixture management utility
├── internal/                # Main application code (hexagonal architecture)
│   ├── domain/              # Core business logic and entities
│   ├── app/                 # Application services/use cases
│   ├── adapters/            # External adapters (database, HTTP, cache)
│   ├── ports/               # HTTP handlers and interfaces
│   ├── config/              # Configuration management
│   └── [utils]/             # Supporting utilities
├── fixtures/                # Test data (Hypixel API responses)
└── .github/workflows/       # CI/CD pipelines
```

### Core Architecture Components

**Domain Layer** (`internal/domain/`):
- `player.go` - Core player data structures (PlayerPIT, GamemodeStatsPIT)
- `account.go` - Minecraft account information 
- `sessions.go` - Game session tracking
- `milestone.go` - Achievement/milestone definitions
- `errors.go` - Domain-specific error types

**Application Layer** (`internal/app/`):
- `get_and_persist.go` - Core player data retrieval and persistence
- `history.go` - Player statistics history
- `sessions.go` - Session management logic
- `milestone.go` - Milestone achievement detection
- Account management services

**Adapters** (`internal/adapters/`):
- `database/` - PostgreSQL database connection and migrations
- `playerprovider/` - Hypixel API integration
- `accountprovider/` - Mojang API integration  
- `playerrepository/` - Database persistence layer
- `cache/` - TTL-based caching implementation

**Ports** (`internal/ports/`):
- HTTP handlers for all API endpoints
- CORS middleware and domain validation
- Request/response converters
- Rate limiting middleware

### Key Configuration Files

- `.pre-commit-config.yaml` - Pre-commit hooks (go-fmt, go-vet, go-build, go-unit-tests)
- `.github/workflows/test-and-deploy.yaml` - CI/CD pipeline
- `.gitignore` - Excludes cmd/.env, coverage files, binaries
- `.gcloudignore` - Excludes test files and utilities from Cloud deployment

### Database Schema

PostgreSQL schema with migrations in `internal/adapters/database/`:
- Separate schemas for production (`flashlight`) and development (`flashlight_test`)
- Migration system automatically runs on startup
- Repository pattern for data access

### API Endpoints

**Core endpoints:**
- `GET /v1/playerdata?uuid=<uuid>` - Main player data endpoint
- `GET /v1/account/username/{username}` - Account lookup by username
- `GET /v1/account/uuid/{uuid}` - Account lookup by UUID  
- `POST /v1/history` - Player statistics history
- `POST /v1/sessions` - Game session data
- `GET /v1/prestiges/{uuid}` - Milestone achievements

**CORS Configuration:**
- Allowed origins: `*.prismoverlay.com`, `*.rainbow-ctx.pages.dev`
- OPTIONS handlers for browser preflight requests

### Dependencies and Integration

**External APIs:**
- Hypixel API - Player statistics (requires API key)
- Mojang API - Username/UUID resolution

**Google Cloud Services:**
- Cloud Run - Application hosting
- Cloud SQL - PostgreSQL database
- Secret Manager - API keys and credentials

**Caching Strategy:**
- Player data: 1 minute TTL
- Account by username: 24 hour TTL  
- Account by UUID: 1 minute TTL (for name changes)

### Development Patterns

**Error Handling:**
- Structured logging with slog (JSON format)
- Sentry integration for error reporting
- Domain-specific error types

**Testing Patterns:**
- Comprehensive unit tests with fixtures
- Integration tests for database operations
- HTTP API testing with mock servers
- Rate limiting validation tests

**Rate Limiting:**
- User ID based limiting (120 requests per user per minute)
- IP based limiting (480 requests per IP per minute) 
- Configurable limits in application logic

## Essential Validation Steps

1. **Before any code change**: Ensure `go fmt ./...` and `go vet ./...` run clean
2. **After code changes**: Run `go fmt ./...` and `go vet ./...` and verify it succeeds
3. **Before submitting**: Run `go test ./internal/...` and ensure all tests pass
4. **For API changes**: Test rate limiting scripts if modifying endpoints
5. **For database changes**: Verify migrations work correctly

**Trust these instructions** - they represent comprehensive analysis of the codebase. Only search for additional information if these instructions are incomplete or incorrect. The repository structure and processes described here are current and accurate.